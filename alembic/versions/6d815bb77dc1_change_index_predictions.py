"""change index predictions

Revision ID: 6d815bb77dc1
Revises: 15a94b3d2592
Create Date: 2025-05-06 11:45:57.856247

"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op
from sqlalchemy.engine.reflection import Inspector

# revision identifiers, used by Alembic.
revision: str = "6d815bb77dc1"
down_revision: Union[str, None] = "15a94b3d2592"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###

    # Get the name of the foreign key constraints in the apicallresponse table
    conn = op.get_bind()
    inspector = Inspector.from_engine(conn)
    foreign_keys = inspector.get_foreign_keys("apicallresponse", schema="noshow")
    foreign_key_names = [
        fk["name"] for fk in foreign_keys if fk["referred_table"] == "apiprediction"
    ]
    for fk_name in foreign_key_names:
        if fk_name is not None:
            op.drop_constraint(
                fk_name,
                "apicallresponse",
                type_="foreignkey",
                schema="noshow",
            )

    # Get the name of the primary key constraint in the apiprediction table
    primary_key_constraint = inspector.get_pk_constraint(
        "apiprediction", schema="noshow"
    )
    primary_key_name = primary_key_constraint["name"]
    if primary_key_name is not None:
        op.drop_constraint(
            primary_key_name,
            "apiprediction",
            type_="primary",
            schema="noshow",
        )

    # Drop the existing index if it exists
    op.drop_index(
        op.f("ix_noshow_apiprediction_id"),
        table_name="apiprediction",
        schema="noshow",
    )

    # Rename old PK column to appointment_id
    op.alter_column(
        "apiprediction",
        "id",
        new_column_name="appointment_id",
        schema="noshow",
    )

    # Add new id column to apiprediction as INT Identity
    op.add_column(
        "apiprediction",
        sa.Column(
            "id",
            sa.Integer(),
            sa.Identity(start=1, increment=1),
            nullable=False,
        ),
        schema="noshow",
    )

    # Create a new primary key constraint on the new id column
    op.create_primary_key(
        "apiprediction_pkey",
        "apiprediction",
        ["id"],
        schema="noshow",
    )

    # Update the values in the prediction_id column to match the new id column
    op.execute(
        """
        UPDATE noshow.apicallresponse
        SET prediction_id = (
            SELECT id
            FROM noshow.apiprediction
            WHERE appointment_id = noshow.apicallresponse.prediction_id
        )
        WHERE prediction_id IS NOT NULL
        """
    )

    op.alter_column(
        "apicallresponse",
        "prediction_id",
        existing_type=sa.VARCHAR(length=50, collation="SQL_Latin1_General_CP1_CI_AS"),
        type_=sa.Integer(),
        existing_nullable=False,
        schema="noshow",
    )

    op.create_foreign_key(
        "apicallresponse_prediction_id_fkey",
        "apicallresponse",
        "apiprediction",
        ["prediction_id"],
        ["id"],
        source_schema="noshow",
        referent_schema="noshow",
    )

    op.create_index(
        op.f("ix_noshow_apiprediction_appointment_id"),
        "apiprediction",
        ["appointment_id"],
        unique=False,
        schema="noshow",
    )

    # Create a new index on the id column
    op.create_index(
        op.f("ix_noshow_apiprediction_id"),
        "apiprediction",
        ["id"],
        unique=True,
        schema="noshow",
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(
        op.f("ix_noshow_apiprediction_appointment_id"),
        table_name="apiprediction",
        schema="noshow",
    )

    # Drop the new index on the id column
    op.drop_index(
        op.f("ix_noshow_apiprediction_id"),
        table_name="apiprediction",
        schema="noshow",
    )

    # Remove any foreign key constraints referencing the id column
    op.drop_constraint(
        "apicallresponse_prediction_id_fkey",
        "apicallresponse",
        type_="foreignkey",
        schema="noshow",
    )

    # Change the type of the prediction_id column back to VARCHAR
    op.alter_column(
        "apicallresponse",
        "prediction_id",
        existing_type=sa.Integer(),
        type_=sa.VARCHAR(length=50, collation="SQL_Latin1_General_CP1_CI_AS"),
        existing_nullable=False,
        schema="noshow",
    )

    # Update the values in the prediction_id column to match the old id column
    op.execute(
        """
        UPDATE noshow.apicallresponse
        SET prediction_id = (
            SELECT appointment_id
            FROM noshow.apiprediction
            WHERE id = noshow.apicallresponse.prediction_id
        )
        WHERE prediction_id IS NOT NULL
        """
    )

    # Drop the new primary key constraint
    op.drop_constraint(
        "apiprediction_pkey",
        "apiprediction",
        type_="primary",
        schema="noshow",
    )

    # Drop the new id column
    op.drop_column("apiprediction", "id", schema="noshow")

    # Rename the appointment_id column back to id
    op.alter_column(
        "apiprediction",
        "appointment_id",
        new_column_name="id",
        schema="noshow",
    )

    # Recreate the old primary key constraint
    op.create_primary_key(
        "apiprediction_pkey",
        "apiprediction",
        ["id"],
        schema="noshow",
    )

    # Recreate Foreign Key constraint
    op.create_foreign_key(
        "apicallresponse_prediction_id_fkey",
        "apicallresponse",
        "apiprediction",
        ["prediction_id"],
        ["id"],
        source_schema="noshow",
        referent_schema="noshow",
    )

    # Recreate the old index on the id column
    op.create_index(
        op.f("ix_noshow_apiprediction_id"),
        "apiprediction",
        ["id"],
        unique=True,
        schema="noshow",
    )

    # ### end Alembic commands ###
